# AutoParc - Car Pool Administration System
## Design Document

---

## 1. SYSTEM ARCHITECTURE

### 1.1 High-Level Architecture
```
┌─────────────────┐
│   React + Vite  │  (Frontend - Port 5173)
│   SPA           │
└────────┬────────┘
         │ HTTP/REST
         │
┌────────▼────────┐
│   Golang API    │  (Backend - Port 8080)
│   REST Server   │
└────────┬────────┘
         │ SQL
         │
┌────────▼────────┐
│   PostgreSQL    │  (Database - Port 5432)
│   RDBMS         │
└─────────────────┘
```

### 1.2 Technology Stack
- **Frontend**: React 18+ with Vite, React Router, Axios
- **Backend**: Golang 1.25 with Gin/Echo framework, Session-based authentication
- **Database**: PostgreSQL 18
- **Session Store**: PostgreSQL (or Redis for future scaling)
- **File Storage**: PostgreSQL BYTEA with compression (gzip)
- **UI Language**: French (all user-facing text, labels, messages, and errors)

### 1.3 Security
- Session-based authentication with HTTP-only cookies
- Password hashing using bcrypt
- CSRF protection with SameSite cookies
- HTTPS in production
- CORS configuration with credentials support for frontend-backend communication
- SQL injection prevention via prepared statements
- Secure session configuration (HTTP-only, Secure, SameSite=Strict flags)

---

## 2. DATA MODEL

### 2.1 Entity Relationship Overview
```
AdministrativeEmployee (1) ──── (N) AuthActivity
                       │
                       └──── (N) Action (audit log)

Car (1) ──── (N) CarOperatorAssignment ──── (N) CarOperator
    │
    ├──── (N) Accident
    │           │
    │           └──── (N) Repair
    │
    ├──── (N) Repair (standalone maintenance)
    │
    ├──── (1) InsuranceCompany
    │
    └──── (N) VehicleInspection
    
Garage (1) ──── (N) Repair
```

### 2.2 Detailed Schema

#### 2.2.1 Core Entities

**administrative_employees**
```
id                  UUID PRIMARY KEY DEFAULT gen_random_uuid()
email               VARCHAR(255) UNIQUE NOT NULL
password_hash       VARCHAR(255) NOT NULL
first_name          VARCHAR(100) NOT NULL
last_name           VARCHAR(100) NOT NULL
role                VARCHAR(50) NOT NULL DEFAULT 'admin'
is_active           BOOLEAN NOT NULL DEFAULT true
created_at          TIMESTAMP NOT NULL DEFAULT NOW()
updated_at          TIMESTAMP NOT NULL DEFAULT NOW()
last_login_at       TIMESTAMP
```

**sessions**
```
id                  UUID PRIMARY KEY DEFAULT gen_random_uuid()
user_id             UUID NOT NULL REFERENCES administrative_employees(id) ON DELETE CASCADE
session_token       VARCHAR(255) UNIQUE NOT NULL
expires_at          TIMESTAMP NOT NULL
created_at          TIMESTAMP NOT NULL DEFAULT NOW()
ip_address          VARCHAR(45)
user_agent          TEXT
```

**cars**
```
id                  UUID PRIMARY KEY DEFAULT gen_random_uuid()
license_plate       VARCHAR(20) UNIQUE NOT NULL
                    CHECK (license_plate ~ '^[A-Z]{2}-[0-9]{3}-[A-Z]{2}$')
brand               VARCHAR(100) NOT NULL
model               VARCHAR(100) NOT NULL
grey_card_number    VARCHAR(100) NOT NULL
insurance_company_id UUID REFERENCES insurance_companies(id)
rental_start_date   DATE
status              VARCHAR(50) NOT NULL DEFAULT 'active'
                    CHECK (status IN ('active', 'maintenance', 'retired'))
created_at          TIMESTAMP NOT NULL DEFAULT NOW()
updated_at          TIMESTAMP NOT NULL DEFAULT NOW()
created_by          UUID REFERENCES administrative_employees(id)
```

**car_operators**
```
id                  UUID PRIMARY KEY DEFAULT gen_random_uuid()
employee_number     VARCHAR(50) UNIQUE NOT NULL
first_name          VARCHAR(100) NOT NULL
last_name           VARCHAR(100) NOT NULL
email               VARCHAR(255)
phone               VARCHAR(50)
department          VARCHAR(100)
is_active           BOOLEAN NOT NULL DEFAULT true
created_at          TIMESTAMP NOT NULL DEFAULT NOW()
updated_at          TIMESTAMP NOT NULL DEFAULT NOW()
created_by          UUID REFERENCES administrative_employees(id)
```

**insurance_companies**
```
id                  UUID PRIMARY KEY DEFAULT gen_random_uuid()
name                VARCHAR(200) NOT NULL
contact_person      VARCHAR(200)
phone               VARCHAR(50)
email               VARCHAR(255)
address             TEXT
policy_number       VARCHAR(100)
is_active           BOOLEAN NOT NULL DEFAULT true
created_at          TIMESTAMP NOT NULL DEFAULT NOW()
updated_at          TIMESTAMP NOT NULL DEFAULT NOW()
created_by          UUID REFERENCES administrative_employees(id)
```

**garages**
```
id                  UUID PRIMARY KEY DEFAULT gen_random_uuid()
name                VARCHAR(200) NOT NULL
contact_person      VARCHAR(200)
phone               VARCHAR(50) NOT NULL
email               VARCHAR(255)
address             TEXT NOT NULL
specialization      VARCHAR(200)
is_active           BOOLEAN NOT NULL DEFAULT true
created_at          TIMESTAMP NOT NULL DEFAULT NOW()
updated_at          TIMESTAMP NOT NULL DEFAULT NOW()
created_by          UUID REFERENCES administrative_employees(id)
```

#### 2.2.2 Relational Entities

**car_operator_assignments**
```
id                  UUID PRIMARY KEY DEFAULT gen_random_uuid()
car_id              UUID NOT NULL REFERENCES cars(id) ON DELETE CASCADE
operator_id         UUID NOT NULL REFERENCES car_operators(id) ON DELETE CASCADE
start_date          DATE NOT NULL
end_date            DATE
notes               TEXT
created_at          TIMESTAMP NOT NULL DEFAULT NOW()
created_by          UUID REFERENCES administrative_employees(id)

CONSTRAINT no_overlap_car CHECK (end_date IS NULL OR end_date >= start_date)
CONSTRAINT unique_active_operator UNIQUE (operator_id, end_date) 
    WHERE end_date IS NULL
CONSTRAINT unique_active_car_assignment UNIQUE (car_id, end_date)
    WHERE end_date IS NULL
```
*Note: Constraints ensure one operator has max 1 car at a time, one car has max 1 operator at a time*

**accidents**
```
id                  UUID PRIMARY KEY DEFAULT gen_random_uuid()
car_id              UUID NOT NULL REFERENCES cars(id) ON DELETE CASCADE
accident_date       TIMESTAMP NOT NULL
location            TEXT NOT NULL
description         TEXT NOT NULL
damages_description TEXT
responsible_party   VARCHAR(200)
police_report_number VARCHAR(100)
insurance_claim_number VARCHAR(100)
status              VARCHAR(50) NOT NULL DEFAULT 'declared'
                    CHECK (status IN ('declared', 'under_review', 'approved', 'closed'))
created_at          TIMESTAMP NOT NULL DEFAULT NOW()
updated_at          TIMESTAMP NOT NULL DEFAULT NOW()
created_by          UUID REFERENCES administrative_employees(id)
```

**accident_photos**
```
id                  UUID PRIMARY KEY DEFAULT gen_random_uuid()
accident_id         UUID NOT NULL REFERENCES accidents(id) ON DELETE CASCADE
filename            VARCHAR(255) NOT NULL
file_data           BYTEA NOT NULL
file_size           INTEGER NOT NULL
mime_type           VARCHAR(100) NOT NULL
compression_type    VARCHAR(50) DEFAULT 'gzip'
description         TEXT
uploaded_at         TIMESTAMP NOT NULL DEFAULT NOW()
uploaded_by         UUID REFERENCES administrative_employees(id)
```

**repairs**
```
id                  UUID PRIMARY KEY DEFAULT gen_random_uuid()
car_id              UUID NOT NULL REFERENCES cars(id) ON DELETE CASCADE
accident_id         UUID REFERENCES accidents(id) ON DELETE SET NULL
garage_id           UUID NOT NULL REFERENCES garages(id)
repair_type         VARCHAR(50) NOT NULL
                    CHECK (repair_type IN ('accident', 'maintenance', 'inspection'))
description         TEXT NOT NULL
start_date          DATE NOT NULL
end_date            DATE
cost                DECIMAL(10,2)
status              VARCHAR(50) NOT NULL DEFAULT 'scheduled'
                    CHECK (status IN ('scheduled', 'in_progress', 'completed', 'cancelled'))
invoice_number      VARCHAR(100)
notes               TEXT
created_at          TIMESTAMP NOT NULL DEFAULT NOW()
updated_at          TIMESTAMP NOT NULL DEFAULT NOW()
created_by          UUID REFERENCES administrative_employees(id)
```

**vehicle_inspections**
```
id                  UUID PRIMARY KEY DEFAULT gen_random_uuid()
car_id              UUID NOT NULL REFERENCES cars(id) ON DELETE CASCADE
inspection_type     VARCHAR(50) NOT NULL
                    CHECK (inspection_type IN ('mandatory', 'random'))
scheduled_date      DATE NOT NULL
completed_date      DATE
result              VARCHAR(50)
                    CHECK (result IN ('passed', 'failed', 'conditional'))
notes               TEXT
next_inspection_date DATE
created_at          TIMESTAMP NOT NULL DEFAULT NOW()
updated_at          TIMESTAMP NOT NULL DEFAULT NOW()
created_by          UUID REFERENCES administrative_employees(id)
```

#### 2.2.3 Audit & Activity Tracking

**action_logs**
```
id                  UUID PRIMARY KEY DEFAULT gen_random_uuid()
entity_type         VARCHAR(50) NOT NULL
                    CHECK (entity_type IN ('car', 'operator', 'accident', 'repair', 
                                           'inspection', 'insurance', 'garage'))
entity_id           UUID NOT NULL
action_type         VARCHAR(50) NOT NULL
                    CHECK (action_type IN ('create', 'update', 'delete', 'assign', 'unassign'))
performed_by        UUID NOT NULL REFERENCES administrative_employees(id)
changes             JSONB
timestamp           TIMESTAMP NOT NULL DEFAULT NOW()
```

### 2.3 Indexes for Performance
```sql
-- Search optimization
CREATE INDEX idx_cars_license_plate ON cars(license_plate);
CREATE INDEX idx_cars_brand_model ON cars(brand, model);
CREATE INDEX idx_operators_name ON car_operators(last_name, first_name);

-- Relationship queries
CREATE INDEX idx_assignments_car ON car_operator_assignments(car_id, end_date);
CREATE INDEX idx_assignments_operator ON car_operator_assignments(operator_id, end_date);
CREATE INDEX idx_accidents_car ON accidents(car_id);
CREATE INDEX idx_repairs_car ON repairs(car_id);
CREATE INDEX idx_repairs_accident ON repairs(accident_id);
CREATE INDEX idx_inspections_car ON vehicle_inspections(car_id);

-- Deadline queries
CREATE INDEX idx_inspections_scheduled ON vehicle_inspections(scheduled_date) 
    WHERE completed_date IS NULL;
CREATE INDEX idx_repairs_dates ON repairs(start_date, end_date, status);

-- Audit
CREATE INDEX idx_action_logs_entity ON action_logs(entity_type, entity_id);
CREATE INDEX idx_action_logs_timestamp ON action_logs(timestamp DESC);

-- Sessions
CREATE INDEX idx_sessions_token ON sessions(session_token);
CREATE INDEX idx_sessions_user ON sessions(user_id);
CREATE INDEX idx_sessions_expires ON sessions(expires_at);
```

---

## 3. API SPECIFICATION

### 3.1 API Design Principles
- RESTful architecture
- JSON request/response format
- HTTP status codes: 200 (OK), 201 (Created), 400 (Bad Request), 401 (Unauthorized), 404 (Not Found), 500 (Internal Error)
- Pagination for list endpoints: `?page=1&limit=20`
- Filtering: `?status=active&brand=Toyota`
- Sorting: `?sort_by=created_at&order=desc`

### 3.2 Authentication Endpoints

#### POST /api/v1/auth/login
```json
Request:
{
  "email": "admin@example.com",
  "password": "securepassword"
}

Response (200):
Sets HTTP-only cookie: session_token=<secure_random_token>; HttpOnly; Secure; SameSite=Strict; Max-Age=604800
{
  "user": {
    "id": "uuid",
    "email": "admin@example.com",
    "first_name": "John",
    "last_name": "Doe",
    "role": "admin"
  }
}
```

#### GET /api/v1/auth/me
Get current authenticated user information
```json
Request: (with session cookie)

Response (200):
{
  "user": {
    "id": "uuid",
    "email": "admin@example.com",
    "first_name": "John",
    "last_name": "Doe",
    "role": "admin"
  }
}
```

#### POST /api/v1/auth/logout
```json
Request: (with session cookie)

Response (200):
Clears cookie: session_token=; Max-Age=0
{
  "message": "Logged out successfully"
}
```

### 3.3 Car Endpoints (MVP - Iteration 1)

#### GET /api/v1/cars
Get list of cars with pagination, filtering, and search
```json
Query Parameters:
- page: integer (default: 1)
- limit: integer (default: 20)
- search: string (searches brand, model, license_plate)
- brand: string
- status: string (active|maintenance|retired)
- sort_by: string (created_at|brand|model)
- order: string (asc|desc)

Response (200):
{
  "data": [
    {
      "id": "uuid",
      "license_plate": "AB-123-CD",
      "brand": "Toyota",
      "model": "Corolla",
      "grey_card_number": "GC123456",
      "insurance_company": {
        "id": "uuid",
        "name": "Insurance Co."
      },
      "status": "active",
      "rental_start_date": "2023-01-15",
      "created_at": "2023-01-16T10:00:00Z",
      "current_operator": {
        "id": "uuid",
        "first_name": "Jane",
        "last_name": "Smith",
        "since": "2023-06-01"
      }
    }
  ],
  "pagination": {
    "current_page": 1,
    "total_pages": 5,
    "total_items": 95,
    "items_per_page": 20
  }
}
```

#### GET /api/v1/cars/:id
Get detailed car information with full history
```json
Response (200):
{
  "id": "uuid",
  "license_plate": "AB-123-CD",
  "brand": "Toyota",
  "model": "Corolla",
  "grey_card_number": "GC123456",
  "insurance_company": {
    "id": "uuid",
    "name": "Insurance Co.",
    "contact_person": "John Doe",
    "phone": "+33123456789"
  },
  "status": "active",
  "rental_start_date": "2023-01-15",
  "created_at": "2023-01-16T10:00:00Z",
  "created_by": {
    "id": "uuid",
    "name": "Admin User"
  },
  "current_assignment": {
    "operator": {
      "id": "uuid",
      "first_name": "Jane",
      "last_name": "Smith",
      "employee_number": "EMP001"
    },
    "start_date": "2023-06-01"
  },
  "history": {
    "assignments": [
      {
        "id": "uuid",
        "operator": { "id": "uuid", "name": "Jane Smith" },
        "start_date": "2023-06-01",
        "end_date": null,
        "created_by": { "id": "uuid", "name": "Admin User" }
      }
    ],
    "accidents": [],
    "repairs": [],
    "inspections": []
  }
}
```

#### POST /api/v1/cars
Create a new car
```json
Request:
{
  "license_plate": "AB-123-CD",  // Format: [A-Z]{2}-[0-9]{3}-[A-Z]{2}
  "brand": "Toyota",
  "model": "Corolla",
  "grey_card_number": "GC123456",
  "insurance_company_id": "uuid",
  "rental_start_date": "2023-01-15",
  "status": "active"
}

Response (201):
{
  "id": "uuid",
  "license_plate": "AB-123-CD",
  "brand": "Toyota",
  "model": "Corolla",
  "grey_card_number": "GC123456",
  "insurance_company_id": "uuid",
  "status": "active",
  "rental_start_date": "2023-01-15",
  "created_at": "2023-01-16T10:00:00Z"
}
```

#### PUT /api/v1/cars/:id
Update car information
```json
Request:
{
  "brand": "Toyota",
  "model": "Corolla Hybrid",
  "insurance_company_id": "uuid",
  "status": "active"
}

Response (200):
{
  "id": "uuid",
  "license_plate": "AB-123-CD",
  "brand": "Toyota",
  "model": "Corolla Hybrid",
  "grey_card_number": "GC123456",
  "insurance_company_id": "uuid",
  "status": "active",
  "rental_start_date": "2023-01-15",
  "updated_at": "2023-06-20T14:30:00Z"
}
```

#### DELETE /api/v1/cars/:id
Delete a car (soft delete by setting status to 'retired')
```json
Response (200):
{
  "message": "Car successfully deleted"
}
```

### 3.4 Administrative Employee Endpoints (Future)

#### GET /api/v1/employees
#### GET /api/v1/employees/:id
#### POST /api/v1/employees
#### PUT /api/v1/employees/:id
#### DELETE /api/v1/employees/:id

### 3.5 Car Operator Endpoints (Future)

#### GET /api/v1/operators
#### GET /api/v1/operators/:id
#### POST /api/v1/operators
#### PUT /api/v1/operators/:id
#### DELETE /api/v1/operators/:id

### 3.6 Insurance Company Endpoints (Future)

#### GET /api/v1/insurance-companies
#### GET /api/v1/insurance-companies/:id
#### POST /api/v1/insurance-companies
#### PUT /api/v1/insurance-companies/:id
#### DELETE /api/v1/insurance-companies/:id

### 3.7 Garage Endpoints (Future)

#### GET /api/v1/garages
#### GET /api/v1/garages/:id
#### POST /api/v1/garages
#### PUT /api/v1/garages/:id
#### DELETE /api/v1/garages/:id

### 3.8 Assignment Endpoints (Future)

#### POST /api/v1/cars/:id/assign
Assign an operator to a car
```json
Request:
{
  "operator_id": "uuid",
  "start_date": "2023-06-01",
  "notes": "New assignment"
}

Response (201):
{
  "id": "uuid",
  "car_id": "uuid",
  "operator_id": "uuid",
  "start_date": "2023-06-01",
  "end_date": null,
  "created_at": "2023-05-30T10:00:00Z"
}
```

#### POST /api/v1/cars/:id/unassign
End current assignment
```json
Request:
{
  "end_date": "2023-08-31",
  "notes": "Operator changed department"
}

Response (200):
{
  "message": "Assignment ended successfully"
}
```

### 3.9 Accident Endpoints (Future)

#### GET /api/v1/accidents
#### GET /api/v1/accidents/:id
#### POST /api/v1/accidents
#### PUT /api/v1/accidents/:id
#### POST /api/v1/accidents/:id/photos (multipart/form-data)
#### GET /api/v1/accidents/:id/photos
#### GET /api/v1/accidents/:id/photos/:photo_id

### 3.10 Repair Endpoints (Future)

#### GET /api/v1/repairs
#### GET /api/v1/repairs/:id
#### POST /api/v1/repairs
#### PUT /api/v1/repairs/:id
#### DELETE /api/v1/repairs/:id

### 3.11 Vehicle Inspection Endpoints (Future)

#### GET /api/v1/inspections
#### GET /api/v1/inspections/:id
#### POST /api/v1/inspections
#### PUT /api/v1/inspections/:id
#### GET /api/v1/inspections/upcoming (deadlines)

### 3.12 Notification/Dashboard Endpoints (Future)

#### GET /api/v1/dashboard
Get summary statistics and upcoming deadlines
```json
Response (200):
{
  "statistics": {
    "total_cars": 95,
    "active_cars": 87,
    "cars_in_maintenance": 5,
    "retired_cars": 3,
    "total_operators": 120,
    "active_assignments": 85,
    "open_accidents": 2,
    "pending_repairs": 8
  },
  "upcoming_deadlines": [
    {
      "type": "vehicle_inspection",
      "car": { "id": "uuid", "license_plate": "AB-123-CD" },
      "scheduled_date": "2026-02-15",
      "days_until": 26,
      "priority": "medium"
    }
  ],
  "recent_activities": [...]
}
```

#### GET /api/v1/notifications
#### POST /api/v1/notifications/:id/mark-read

---

## 4. MVP - ITERATION 1

### 4.1 Scope
**Goal**: Create a functional car management system with CRUD operations and search capability.

**Features Included**:
1. ✅ User Authentication (Login/Logout)
2. ✅ Car Management (Full CRUD)
3. ✅ Search & Filter Cars (by brand, model, license plate)
4. ✅ Basic Car Listing with Pagination
5. ✅ View Car Details

**Features Excluded** (Future iterations):
- Car operator management
- Car-operator assignments
- Insurance companies & garages management
- Accidents & repairs
- Vehicle inspections
- Notification center & deadlines
- Email notifications
- Advanced reporting

### 4.2 Database Setup for MVP
Only the following tables:
- `administrative_employees`
- `sessions`
- `cars`
- `insurance_companies` (basic, for car reference)
- `action_logs` (for audit)

### 4.3 API Endpoints for MVP
- `POST /api/v1/auth/login`
- `GET /api/v1/auth/me`
- `POST /api/v1/auth/logout`
- `GET /api/v1/cars` (with search, filter, pagination)
- `GET /api/v1/cars/:id`
- `POST /api/v1/cars`
- `PUT /api/v1/cars/:id`
- `DELETE /api/v1/cars/:id`
- `GET /api/v1/insurance-companies` (basic list only)

### 4.4 Frontend Components for MVP

**Pages**:
1. **Login Page** (`/login`)
   - Email & password form
   - Session cookie automatically handled by browser

2. **Dashboard/Home Page** (`/`)
   - Welcome message
   - Search bar (searches brand, model, license plate)
   - Quick stats (total cars, active cars)
   - Link to car listing

3. **Car List Page** (`/cars`)
   - Table/grid view of all cars
   - Columns: License Plate, Brand, Model, Status, Actions
   - Pagination controls
   - Filter by status
   - Search box
   - "Add New Car" button

4. **Car Detail Page** (`/cars/:id`)
   - Display all car information
   - Insurance company details
   - Edit/Delete buttons
   - Created/Updated metadata

5. **Car Form Page** (`/cars/new` and `/cars/:id/edit`)
   - Form fields: license_plate, brand, model, grey_card_number, insurance_company (dropdown), rental_start_date, status
   - Validation:
     - license_plate: Required, must match pattern [A-Z]{2}-[0-9]{3}-[A-Z]{2} (e.g., AB-123-CD)
     - All required fields validation
   - Submit/Cancel buttons

**Components**:
- `Navbar` (with logout)
- `SearchBar`
- `CarTable/CarGrid`
- `CarCard`
- `CarForm`
- `Pagination`
- `FilterPanel`
- `ProtectedRoute` (auth guard)

**Localization**:
- All UI text in French (buttons, labels, placeholders, error messages)
- Date formatting: French format (DD/MM/YYYY)
- Examples of French labels:
  - "Connexion" (Login)
  - "Déconnexion" (Logout)
  - "Véhicules" (Cars)
  - "Plaque d'immatriculation" (License Plate)
  - "Marque" (Brand)
  - "Modèle" (Model)
  - "Statut" (Status)
  - "Ajouter un véhicule" (Add New Car)
  - "Modifier" (Edit)
  - "Supprimer" (Delete)
  - "Rechercher" (Search)

### 4.5 Success Criteria for MVP
- ✅ Admin can login/logout
- ✅ Admin can create a new car
- ✅ Admin can view list of all cars with pagination
- ✅ Admin can search for cars by license plate, brand, or model
- ✅ Admin can filter cars by status
- ✅ Admin can view detailed information about a specific car
- ✅ Admin can edit car information
- ✅ Admin can delete a car
- ✅ All actions are logged in action_logs table

---

## 5. FUTURE ITERATIONS

### 5.1 Iteration 2 - Operators & Assignments
**Features**:
- Car operator CRUD
- Assign/unassign operators to cars
- View assignment history
- Validation: one operator = one car at a time
- View operator details with their car history

**Database**:
- `car_operators`
- `car_operator_assignments`

**API Endpoints**:
- All operator endpoints
- Assignment endpoints

### 5.2 Iteration 3 - Accidents & Repairs
**Features**:
- Declare accidents with photo uploads
- Link repairs to accidents
- Create standalone repairs (maintenance)
- Garage management
- View accident/repair history per car

**Database**:
- `garages`
- `accidents`
- `accident_photos`
- `repairs`

**API Endpoints**:
- Accident endpoints
- Repair endpoints
- Garage endpoints
- Photo upload/retrieval

### 5.3 Iteration 4 - Vehicle Inspections & Deadlines
**Features**:
- Schedule mandatory inspections (every 2 years)
- Schedule random controls (2x per year)
- Auto-calculate next inspection dates
- Manual deadline override
- View upcoming deadlines
- Mark inspections as completed

**Database**:
- `vehicle_inspections`

**API Endpoints**:
- Inspection endpoints
- Dashboard with deadlines

### 5.4 Iteration 5 - Notification Center
**Features**:
- Dashboard with upcoming deadlines
- Calendar view of inspections/repairs
- Notification center UI
- Mark notifications as read
- Priority-based sorting
- Summary statistics

**API Endpoints**:
- Dashboard endpoint
- Notifications endpoint

### 5.5 Iteration 6 - Email Notifications
**Features**:
- Email service integration (SMTP or SendGrid)
- Configurable email templates
- Automatic emails for:
  - Upcoming inspections (7 days, 3 days, 1 day before)
  - Overdue inspections
  - Accident declarations
  - Repair completions
- Email preferences per admin user

**New Components**:
- Email service in backend
- Email queue/scheduler

### 5.6 Iteration 7 - Advanced Features
**Features**:
- Multi-role support (admin, viewer, super-admin)
- Advanced search with multiple filters
- Export data to CSV/PDF
- Reporting & analytics
- File attachments for repairs/inspections
- Cost tracking & budgeting
- Car maintenance schedules

---

## 6. COMPONENT INTERACTIONS

### 6.1 Key Workflows

#### Workflow 1: Add New Car (MVP)
```
User → Frontend (Car Form)
  ↓ POST /api/v1/cars
Backend → Validate data
  ↓
Backend → Insert into 'cars' table
  ↓
Backend → Log action in 'action_logs'
  ↓
Backend → Return created car
  ↓
Frontend → Redirect to car detail page
```

#### Workflow 2: Search for Car (MVP)
```
User → Frontend (Search bar)
  ↓ GET /api/v1/cars?search=AB-123
Backend → Query database with ILIKE on license_plate, brand, model
  ↓
Backend → Return paginated results
  ↓
Frontend → Display car list
```

#### Workflow 3: Assign Operator to Car (Future - Iteration 2)
```
User → Frontend (Assignment form)
  ↓ POST /api/v1/cars/:id/assign
Backend → Check: operator has no active assignment
Backend → Check: car has no active assignment
  ↓
Backend → Insert into 'car_operator_assignments' with end_date=NULL
  ↓
Backend → Log action
  ↓
Backend → Return assignment
  ↓
Frontend → Update car detail view
```

#### Workflow 4: Declare Accident (Future - Iteration 3)
```
User → Frontend (Accident form + photo upload)
  ↓ POST /api/v1/accidents
Backend → Insert into 'accidents'
  ↓ POST /api/v1/accidents/:id/photos (for each photo)
Backend → Compress photo (gzip)
Backend → Store in 'accident_photos' as BYTEA
  ↓
Backend → Log action
  ↓
Backend → Return accident with photo IDs
  ↓
Frontend → Display accident details
```

#### Workflow 5: Calculate Inspection Deadline (Future - Iteration 4)
```
Scheduled Job (runs daily)
  ↓
Backend → Query all cars
Backend → For each car without pending inspection:
  - Get last inspection date
  - Calculate next_inspection_date = last + 2 years
  - If next_inspection_date < NOW + 30 days:
    Create notification
  ↓
Backend → Store in notifications table
  ↓
Frontend → Display in notification center
```

### 6.2 Authentication Flow
```
User enters credentials
  ↓ POST /api/v1/auth/login
Backend → Verify password (bcrypt)
Backend → Generate secure random session token
Backend → Store session in 'sessions' table
Backend → Set HTTP-only cookie with session token
  ↓
Frontend → Browser automatically stores cookie
Frontend → Cookie automatically sent with all requests to same domain
  ↓
Backend → Validate session token from cookie on each request
Backend → Look up user_id from sessions table
Backend → Verify session not expired
Backend → Use user_id for action logging
  ↓
On Logout:
Backend → Delete session from database
Backend → Clear cookie
```

---

## 7. TECHNICAL CONSIDERATIONS

### 7.1 Backend Structure (Golang)
```
cmd/
  api/
    main.go
internal/
  config/
  middleware/
    auth.go
    logger.go
    cors.go
  models/
    car.go
    user.go
    ...
  handlers/
    auth_handler.go
    car_handler.go
    ...
  repository/
    car_repository.go
    user_repository.go
    ...
  service/
    car_service.go
    auth_service.go
    ...
  database/
    postgres.go
    migrations/
pkg/
  utils/
    jwt.go
    password.go
```

### 7.2 Frontend Structure (React + Vite)
```
src/
  components/
    common/
      Navbar.jsx
      SearchBar.jsx
      Pagination.jsx
    cars/
      CarList.jsx
      CarCard.jsx
      CarForm.jsx
      CarDetail.jsx
  pages/
    LoginPage.jsx
    DashboardPage.jsx
    CarsPage.jsx
    CarDetailPage.jsx
    CarEditPage.jsx
  services/
    api.js
    auth.js
    carService.js
  contexts/
    AuthContext.jsx
  hooks/
    useAuth.js
    useCars.js
  utils/
    constants.js
    validators.js
  App.jsx
  main.jsx
```

### 7.3 Photo Compression Strategy
- Frontend: Resize images before upload (max 1920px width)
- Backend: Compress with gzip before storing in PostgreSQL
- Store original filename, size, and mime_type for retrieval
- On retrieval: decompress and send with appropriate Content-Type header

### 7.4 Database Migration Strategy
- Use golang-migrate or similar tool
- Version-controlled migration files
- Each iteration has its own migration set
- Rollback capability for each migration

### 7.5 Testing Strategy

#### 7.5.1 Testing Requirements
- **All functions must have unit tests**
- **All features must have functional tests**
- **Minimum code coverage target: 80%**
- **Tests must pass before merging to main branch**

#### 7.5.2 Backend Testing (Golang)

**Unit Tests**:
- **Framework**: `testing` (standard library) + `testify/assert` for assertions
- **Test all functions** in services, handlers, and utilities
- **Mock dependencies**: Use `testify/mock` or `gomock` for database, external services
- **Test coverage**: Use `go test -cover` and aim for 80%+ coverage

**Test Structure**:
```
internal/
  service/
    car_service.go
    car_service_test.go
  handlers/
    car_handler.go
    car_handler_test.go
  repository/
    car_repository.go
    car_repository_test.go
```

**Unit Test Examples**:
- Service layer: Business logic validation, data transformation
- Repository layer: Database query logic (with mock database)
- Handler layer: Request validation, response formatting (with mock service)
- Utilities: Password hashing, validation functions, token generation

**Integration Tests**:
- **Framework**: `testify/suite` + `dockertest` for PostgreSQL container
- Test complete workflows: Login → Create Car → Fetch Car → Update → Delete
- Test database constraints and migrations
- Test session management and authentication flows

**Test Database**:
- Use `dockertest` to spin up PostgreSQL container for integration tests
- Run migrations before each test suite
- Clean database between tests

#### 7.5.3 Frontend Testing (React)

**Unit Tests**:
- **Framework**: Vitest + React Testing Library
- **Test all components**: Rendering, props, user interactions
- **Test hooks**: Custom hooks like `useAuth`, `useCars`
- **Test utilities**: Validation functions, formatters

**Component Test Examples**:
```
src/
  components/
    cars/
      CarList.jsx
      CarList.test.jsx
      CarForm.jsx
      CarForm.test.jsx
```

**What to Test**:
- Component rendering with different props
- User interactions (clicks, form inputs)
- Conditional rendering based on state
- Form validation logic
- Error handling and display

**Integration Tests**:
- **Framework**: React Testing Library
- Test page-level components with mocked API calls
- Test routing and navigation
- Test authentication flows

**End-to-End Tests**:
- **Framework**: Playwright or Cypress
- Test complete user workflows:
  - Login flow
  - Create new car workflow
  - Search and filter cars
  - Edit car details
  - Delete car
- Run against development server with test database

#### 7.5.4 API Testing

**Manual Testing**:
- **Tool**: Postman or Insomnia
- Create collection with all endpoints
- Test request/response formats
- Test error scenarios

**Automated API Tests**:
- **Framework**: Postman/Newman or Go integration tests
- Test all CRUD operations
- Test authentication and authorization
- Test input validation and error responses
- Test pagination, filtering, and sorting

#### 7.5.5 Test Organization for MVP

**MVP Test Coverage**:
- ✅ Unit tests for all service functions (auth, car CRUD, session management)
- ✅ Unit tests for all repository functions (database queries)
- ✅ Unit tests for handlers (request/response processing)
- ✅ Unit tests for validation functions (license plate regex, etc.)
- ✅ Integration tests for authentication flow
- ✅ Integration tests for car CRUD operations
- ✅ Frontend unit tests for Car components
- ✅ Frontend unit tests for authentication components
- ✅ E2E test for complete user workflow (login → create car → view → logout)

**Test Execution**:
```bash
# Backend
go test ./... -cover -v

# Frontend
npm run test
npm run test:coverage

# E2E
npm run test:e2e
```

#### 7.5.6 Continuous Integration

**CI Pipeline Requirements**:
- Run all unit tests on each commit
- Run integration tests before merge
- Generate code coverage reports
- Block merge if tests fail or coverage drops below 80%
- Run E2E tests on staging environment

**Tools**: GitHub Actions, GitLab CI, or Jenkins

#### 7.5.7 Test Data Management

**Test Fixtures**:
- Create test data fixtures for consistent testing
- Use factory pattern for generating test objects
- Mock external dependencies (insurance companies, etc.)

**Example Test Data**:
```go
// fixtures/car_fixtures.go
func ValidCarData() map[string]interface{} {
    return map[string]interface{}{
        "license_plate": "AB-123-CD",
        "brand": "Toyota",
        "model": "Corolla",
        "grey_card_number": "GC123456",
        "rental_start_date": "2023-01-15",
        "status": "active",
    }
}
```

---

## 8. CI/CD PIPELINE WITH GITHUB ACTIONS

### 8.1 Pipeline Overview
The CI/CD pipeline will automate testing, building, and deployment using GitHub Actions. The pipeline ensures code quality, runs all tests, and deploys to staging/production environments.

### 8.2 Workflow Structure

#### 8.2.1 Backend Workflow (.github/workflows/backend.yml)

**Triggers**:
- Push to `main` branch
- Pull requests to `main` branch
- Manual workflow dispatch

**Jobs**:

**1. Lint & Format Check**
```yaml
lint:
  runs-on: ubuntu-latest
  steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.25'
    
    - name: Run golangci-lint
      uses: golangci/golangci-lint-action@v4
      with:
        version: latest
        args: --timeout=5m
```

**2. Unit Tests**
```yaml
unit-tests:
  runs-on: ubuntu-latest
  steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.25'
    
    - name: Run unit tests
      run: |
        go test ./... -v -coverprofile=coverage.out -covermode=atomic
    
    - name: Check coverage threshold
      run: |
        coverage=$(go tool cover -func=coverage.out | grep total | awk '{print $3}' | sed 's/%//')
        echo "Coverage: $coverage%"
        if (( $(echo "$coverage < 80" | bc -l) )); then
          echo "Coverage $coverage% is below 80% threshold"
          exit 1
        fi
    
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        files: ./coverage.out
        flags: backend
```

**3. Integration Tests**
```yaml
integration-tests:
  runs-on: ubuntu-latest
  services:
    postgres:
      image: postgres:18
      env:
        POSTGRES_DB: autoparc_test
        POSTGRES_USER: test_user
        POSTGRES_PASSWORD: test_password
      options: >-
        --health-cmd pg_isready
        --health-interval 10s
        --health-timeout 5s
        --health-retries 5
      ports:
        - 5432:5432
  
  steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.25'
    
    - name: Run migrations
      run: |
        # Install golang-migrate
        go install -tags 'postgres' github.com/golang-migrate/migrate/v4/cmd/migrate@latest
        # Run migrations
        migrate -path ./migrations -database "postgresql://test_user:test_password@localhost:5432/autoparc_test?sslmode=disable" up
    
    - name: Run integration tests
      env:
        DATABASE_URL: "postgresql://test_user:test_password@localhost:5432/autoparc_test?sslmode=disable"
      run: |
        go test ./tests/integration/... -v
```

**4. Build**
```yaml
build:
  runs-on: ubuntu-latest
  needs: [lint, unit-tests, integration-tests]
  steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.25'
    
    - name: Build binary
      run: |
        CGO_ENABLED=0 GOOS=linux go build -o autoparc-api ./cmd/api
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: autoparc-api
        path: autoparc-api
```

#### 8.2.2 Frontend Workflow (.github/workflows/frontend.yml)

**Triggers**:
- Push to `main` branch
- Pull requests to `main` branch
- Manual workflow dispatch

**Jobs**:

**1. Lint & Format Check**
```yaml
lint:
  runs-on: ubuntu-latest
  steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
    
    - name: Install dependencies
      working-directory: ./frontend
      run: npm ci
    
    - name: Run ESLint
      working-directory: ./frontend
      run: npm run lint
```

**2. Unit Tests**
```yaml
unit-tests:
  runs-on: ubuntu-latest
  steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
    
    - name: Install dependencies
      working-directory: ./frontend
      run: npm ci
    
    - name: Run tests with coverage
      working-directory: ./frontend
      run: npm run test:coverage
    
    - name: Check coverage threshold
      working-directory: ./frontend
      run: |
        # Vitest outputs coverage summary
        # This step would parse and check the coverage
        npm run test:coverage -- --reporter=json --outputFile=coverage.json
    
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        files: ./frontend/coverage/coverage-final.json
        flags: frontend
```

**3. Build**
```yaml
build:
  runs-on: ubuntu-latest
  needs: [lint, unit-tests]
  steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
    
    - name: Install dependencies
      working-directory: ./frontend
      run: npm ci
    
    - name: Build for production
      working-directory: ./frontend
      run: npm run build
      env:
        VITE_API_URL: ${{ secrets.API_URL }}
    
    - name: Upload build artifact
      uses: actions/upload-artifact@v4
      with:
        name: frontend-dist
        path: frontend/dist
```

#### 8.2.3 E2E Tests Workflow (.github/workflows/e2e.yml)

**Triggers**:
- Pull requests to `main` branch
- Scheduled (nightly)
- Manual workflow dispatch

**Jobs**:
```yaml
e2e-tests:
  runs-on: ubuntu-latest
  services:
    postgres:
      image: postgres:18
      env:
        POSTGRES_DB: autoparc_e2e
        POSTGRES_USER: e2e_user
        POSTGRES_PASSWORD: e2e_password
      options: >-
        --health-cmd pg_isready
        --health-interval 10s
        --health-timeout 5s
        --health-retries 5
      ports:
        - 5432:5432
  
  steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.25'
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: Run migrations
      run: |
        go install -tags 'postgres' github.com/golang-migrate/migrate/v4/cmd/migrate@latest
        migrate -path ./migrations -database "postgresql://e2e_user:e2e_password@localhost:5432/autoparc_e2e?sslmode=disable" up
    
    - name: Start backend server
      run: |
        cd backend
        go build -o autoparc-api ./cmd/api
        ./autoparc-api &
      env:
        DATABASE_URL: "postgresql://e2e_user:e2e_password@localhost:5432/autoparc_e2e?sslmode=disable"
        PORT: 8080
    
    - name: Install frontend dependencies
      working-directory: ./frontend
      run: npm ci
    
    - name: Install Playwright
      working-directory: ./frontend
      run: npx playwright install --with-deps
    
    - name: Run E2E tests
      working-directory: ./frontend
      run: npm run test:e2e
      env:
        VITE_API_URL: http://localhost:8080
    
    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: playwright-report
        path: frontend/playwright-report
```

#### 8.2.4 Deployment Workflow (.github/workflows/deploy.yml)

**Triggers**:
- Push to `main` branch (only after all tests pass)
- Manual workflow dispatch

**Jobs**:

**1. Deploy to Staging**
```yaml
deploy-staging:
  runs-on: ubuntu-latest
  needs: [backend-build, frontend-build, e2e-tests]
  environment: staging
  steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Download backend artifact
      uses: actions/download-artifact@v4
      with:
        name: autoparc-api
    
    - name: Download frontend artifact
      uses: actions/download-artifact@v4
      with:
        name: frontend-dist
    
    - name: Deploy to staging server
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.STAGING_HOST }}
        username: ${{ secrets.STAGING_USER }}
        key: ${{ secrets.STAGING_SSH_KEY }}
        source: "autoparc-api,dist"
        target: "/var/www/autoparc-staging"
    
    - name: Restart services
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.STAGING_HOST }}
        username: ${{ secrets.STAGING_USER }}
        key: ${{ secrets.STAGING_SSH_KEY }}
        script: |
          sudo systemctl restart autoparc-api
          sudo systemctl restart nginx
```

**2. Deploy to Production** (with manual approval)
```yaml
deploy-production:
  runs-on: ubuntu-latest
  needs: deploy-staging
  environment: production
  steps:
    - name: Download artifacts
      uses: actions/download-artifact@v4
    
    - name: Deploy to production
      # Similar to staging but with production secrets
      # Includes database backup before deployment
```

### 8.3 Required GitHub Secrets

**Backend**:
- `DATABASE_URL` - Production database connection string
- `SESSION_SECRET` - Secret for session encryption

**Frontend**:
- `API_URL` - Production API endpoint

**Deployment**:
- `STAGING_HOST` - Staging server hostname
- `STAGING_USER` - SSH username for staging
- `STAGING_SSH_KEY` - SSH private key for staging
- `PRODUCTION_HOST` - Production server hostname
- `PRODUCTION_USER` - SSH username for production
- `PRODUCTION_SSH_KEY` - SSH private key for production

**Optional**:
- `CODECOV_TOKEN` - Token for Codecov integration
- `SLACK_WEBHOOK` - Webhook for deployment notifications

### 8.4 Branch Protection Rules

Configure branch protection for `main` branch:
- ✅ Require pull request before merging
- ✅ Require status checks to pass:
  - Backend lint
  - Backend unit tests
  - Backend integration tests
  - Frontend lint
  - Frontend unit tests
  - Frontend build
- ✅ Require branches to be up to date
- ✅ Require code review approval (1+ reviewers)
- ✅ Dismiss stale pull request approvals when new commits are pushed

### 8.5 Workflow Badges

Add badges to README.md:
```markdown
![Backend Tests](https://github.com/username/autoparc/workflows/backend/badge.svg)
![Frontend Tests](https://github.com/username/autoparc/workflows/frontend/badge.svg)
![E2E Tests](https://github.com/username/autoparc/workflows/e2e/badge.svg)
[![codecov](https://codecov.io/gh/username/autoparc/branch/main/graph/badge.svg)](https://codecov.io/gh/username/autoparc)
```

### 8.6 Notification Strategy

**On Success**:
- Merge to main: No notification (expected behavior)
- Deployment to staging: Slack notification with build info
- Deployment to production: Slack notification + email to team

**On Failure**:
- Test failures: GitHub UI notification to PR author
- Build failures: Email to committer
- Deployment failures: Slack alert + email to DevOps team

### 8.7 Performance Optimizations

**Caching**:
- Cache Go modules: `actions/setup-go` with caching
- Cache npm dependencies: `actions/setup-node` with cache
- Cache build artifacts between jobs

**Parallelization**:
- Run backend and frontend pipelines in parallel
- Run unit tests in parallel when possible

**Job Timeouts**:
- Lint jobs: 5 minutes
- Unit test jobs: 10 minutes
- Integration test jobs: 15 minutes
- E2E test jobs: 30 minutes
- Build jobs: 10 minutes

### 8.8 MVP CI/CD Requirements

For MVP (Iteration 1), implement:
- ✅ Backend workflow (lint, unit tests, integration tests, build)
- ✅ Frontend workflow (lint, unit tests, build)
- ✅ E2E workflow (basic login + car CRUD tests)
- ✅ Branch protection on `main`
- ✅ Code coverage reporting (Codecov or similar)

For Future Iterations:
- Automated deployment to staging
- Production deployment with manual approval
- Database migration automation in CI
- Performance testing integration
- Security scanning (Snyk, Dependabot)

---

## 9. DEPLOYMENT CONSIDERATIONS (Future)

### 8.1 Development Environment
- Docker Compose with 3 services: frontend, backend, database
- Hot reload for both frontend and backend
- Volume mounts for persistence

### 8.2 Production Environment
- Docker containers or bare metal
- HTTPS with Let's Encrypt
- PostgreSQL with regular backups
- Environment variables for configuration
- Log aggregation (optional)
- Monitoring (optional)

---

## SUMMARY

This design document provides a complete architecture for the AutoParc system. The MVP (Iteration 1) focuses on delivering a working car management system with authentication, CRUD operations, and search functionality. Future iterations will progressively add operators, assignments, accidents, repairs, inspections, notifications, and email capabilities.

The design ensures:
- **Time-saving**: Quick access to car information through search
- **Deadline tracking**: Automated calculation of inspection deadlines (Iteration 4+)
- **Todo management**: Notification center for pending tasks (Iteration 5+)
- **Comprehensive history**: Full audit log of all actions and relationships
- **Scalability**: Modular design allows easy addition of features
- **Data integrity**: Proper constraints and validations at database level