name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  # Determine what changed
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.filter.outputs.backend }}
      frontend: ${{ steps.filter.outputs.frontend }}
      migrations: ${{ steps.filter.outputs.migrations }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Check for changes
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            backend:
              - 'backend/**'
              - '.github/workflows/backend.yml'
              - '.github/workflows/ci.yml'
            frontend:
              - 'frontend/**'
              - '.github/workflows/frontend.yml'
              - '.github/workflows/ci.yml'
            migrations:
              - 'migrations/**'

  # Backend CI
  backend-ci:
    name: Backend CI
    needs: changes
    if: needs.changes.outputs.backend == 'true' || needs.changes.outputs.migrations == 'true'
    uses: ./.github/workflows/backend.yml

  # Frontend CI
  frontend-ci:
    name: Frontend CI
    needs: changes
    if: needs.changes.outputs.frontend == 'true'
    uses: ./.github/workflows/frontend.yml

  # E2E Tests (only on PRs)
  e2e-tests:
    name: E2E Tests
    needs: changes
    if: |
      github.event_name == 'pull_request' && (
        needs.changes.outputs.backend == 'true' || 
        needs.changes.outputs.frontend == 'true' || 
        needs.changes.outputs.migrations == 'true'
      )
    uses: ./.github/workflows/e2e.yml

  # Run full validation script
  validate:
    name: Full CI Validation
    uses: ./.github/workflows/validate.yml

  # Status check for required checks
  status:
    name: CI Status
    runs-on: ubuntu-latest
    needs: [changes, backend-ci, frontend-ci, validate]
    if: always()
    steps:
      - name: Check CI status
        run: |
          if [ "${{ needs.backend-ci.result }}" == "failure" ] || [ "${{ needs.frontend-ci.result }}" == "failure" ] || [ "${{ needs.validate.result }}" == "failure" ]; then
            echo "CI checks failed"
            exit 1
          fi
          if [ "${{ needs.backend-ci.result }}" == "skipped" ] && [ "${{ needs.frontend-ci.result }}" == "skipped" ]; then
            echo "No changes detected, skipping CI"
            exit 0
          fi
          echo "All CI checks passed"
